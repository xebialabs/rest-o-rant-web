buildscript {
  repositories {
    mavenCentral()
    jcenter()
  }

  dependencies {
    classpath 'com.bmuschko:gradle-docker-plugin:2.6.7'
  }
}

apply plugin: 'war'
apply plugin: 'jetty'
apply plugin: 'com.bmuschko.docker-remote-api'

import com.bmuschko.gradle.docker.tasks.image.Dockerfile
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage

repositories {
  mavenCentral()
}

task copyDistWebapp(type: Copy) {
  from('src/main/webapp')
  into('build/distributions/rest-o-rant-web')
}

build.dependsOn copyDistWebapp

dependencies {
  compile group: 'commons-io', name: 'commons-io', version: '1.4'
  compile group: 'log4j', name: 'log4j', version: '1.2.15', ext: 'jar'
}

docker {
  url = 'https://192.168.99.100:2376'
  certPath = new File(System.properties['user.home'], '.docker/machine/machines/default/')
}

task copyWebapp(type: Copy) {
  from('src/main/webapp')
  into('build/docker/webapp')
}

task copyNginx(type: Copy) {
  from('src/main/nginx')
  into('build/docker/nginx')
}

task createDockerfile(type: Dockerfile) {
  dependsOn copyWebapp, copyNginx
  destFile = project.file('build/docker/Dockerfile')
  from 'nginx'
  maintainer 'Vincent Partington <vpartington@xebialabs.com>'
  copyFile('webapp', '/usr/share/nginx/html')
  copyFile('nginx', '/etc/nginx/conf.d')
}

task buildDockerImage(type: DockerBuildImage) {
  dependsOn createDockerfile
  inputDir = createDockerfile.destFile.parentFile
  tag = "dkr-reg:5000/rest-o-rant-web:$version"
}

task wrapper(type: Wrapper) {
  gradleVersion = '2.11'
}

httpPort = 8080
stopPort = 9451
stopKey = 'stop-rest-o-rant-web'
